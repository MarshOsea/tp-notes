# IM系统核心技术挑战

## 1. 群消息推送 

绝大部分IM系统中支持群聊模式，群聊功能也是整个IM系统中的技术难点所在，可以分为以下几个方面:

1. **稳定性**

   假设一个群成员超过10000人的大群，每当群成员向群中发送一条消息，该消息在投递的过程中就要同时投递至剩余所有成员，存在读写扩散问题，服务器与数据库压力较大，影响系统稳定性

2. **用户体验**

   群成员较多情况下，获取群成员列表延时较高，影响客户体验。

3. **成本**

   群聊中的新消息投递与存储会大量消耗服务器资源，增加成本。

解决方案与思路：

1. **大群限流**

   通过对热点大群流量限制来保证服务与数据库的稳定性，设置流量阈值，超过阈值后通过限制群成员发送消息数量和速度来保证稳定性，在系统容量恢复后允许继续发送消息.

2. **读写混合**

   群消息以会话维度存储，每个群维护一个独立的收件箱，群成员中的消息读写都在该表中操作，规避读写扩散问题，大幅度提升性能并减小服务端与数据库压力。

   1. ***写扩散***

   ​    每个用户都维护一个收件箱，当群成员发送消息的时候，服务端收到消息后，会在群的消息表记录一条数据，并且把此条消息插入到每个群成员的收件箱中，在此种模式下，每个群成员读取未读消息时只需要拉取自己收件箱中的消息即可

   2. ***读扩散***

   ​	写扩散与读扩散相反，每个群成员拥有一个独立的发件箱，当群里成员发送一条新消息，服务端接收此消息后，将此消息写入发消息成员的发件箱中，每个成员读取未读消息时，需要遍历读取所有群成员的发件箱。

   通过读写混合模型的方式，可有效缓解数据库和服务器压力

3. **群成员列表本地缓存化**

   群成员通常情况下不会一次性进行大批量增删，依据这种特性，在从服务端拉取群成员的过程中，可以把结果存入缓存，便于后续使用，并且通过增量更新的方式来保证远端数据库和本地缓存结果的一致性，通过一致性校验来保证在增量更新失败的情况下数据一致性。

   ## 2. 历史消息拉取

1. **推模型**

   客户端与服务端建立连接后，通过服务端主动消息下发的模式，把未读消息按照时间顺序推送至客户端，当消息数量大于推送阈值时，会抛弃部分消息，这种情况下会导致消息同步不完整情况

2. **拉模型**

   客户端与服务端建立连接后，客户端根据上次拉取时间标志，拉取标志之后所有的消息至本地

3. **推拉模型**

   结合推拉模式，当推模式中消息数量大8于阈值时，客户端会再次通过主动拉取服务端消息来保证数据同步的完整性

   ## 3.消息存储冷热分离

   根据消息时间来确定消息的冷热属性，用户通常访问并修改的大部分是近期消息，将近期用户消息保存至热库中，历史消息保存在冷库中，尽量保证最小次数查询冷库中的数据。冷热数据分离储存后，数据结构维护效率大幅度提升，由于热库中只存储4天数据，索引、表结构变更速度较之前大幅度提升	